<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEA Decryption Tool</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 2em auto;
            padding: 1.5em;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: #fcfcfc;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 1.5em;
        }
        label {
            display: block;
            margin-bottom: 0.5em;
            color: #555;
            font-weight: bold;
        }
        textarea, input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 1.5em;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
        }
        button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        #statusMessage {
            margin-top: 1em;
            color: red;
            font-weight: bold;
            text-align: center;
        }
        #decryptedOutputContainer {
            margin-top: 2em;
            padding: 1.2em;
            background-color: #e9f7ef;
            border: 1px solid #c2e0d0;
            border-radius: 5px;
        }
        #decryptedOutput {
            white-space: pre-wrap; /* Preserves whitespace and line breaks */
            word-wrap: break-word; /* Breaks long words */
            font-family: monospace;
            color: #333;
            font-size: 0.95em;
            min-height: 50px;
        }
        .info {
            font-size: 0.85em;
            color: #666;
            margin-top: -1em;
            margin-bottom: 1.5em;
        }
    </style>
</head>
<body>
    <h1>TEA Decryption Tool</h1>
    <p class="info">This tool decrypts text using the Tiny Encryption Algorithm (TEA) as implemented in your provided TiddlyWiki plugin. This is for decrypting *existing* data; TEA is not recommended for new encryption due to known security weaknesses.</p>

    <label for="encryptedText">Encrypted Text:</label>
    <textarea id="encryptedText" rows="10" placeholder="Paste the encrypted text here. This should be the content that starts AFTER 'Encrypted(SHA1_HASH)' in your tiddler."></textarea>

    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Enter the decryption password">

    <button id="decryptButton">Decrypt</button>

    <div id="statusMessage"></div>

    <div id="decryptedOutputContainer">
        <label>Decrypted Output:</label>
        <div id="decryptedOutput"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const encryptedTextInput = document.getElementById('encryptedText');
            const passwordInput = document.getElementById('password');
            const decryptButton = document.getElementById('decryptButton');
            const decryptedOutput = document.getElementById('decryptedOutput');
            const statusMessage = document.getElementById('statusMessage');

            // --- Core TEA Decryption Functions (extracted and adapted) ---

            // TEAdecrypt: Use Corrected Block TEA to decrypt ciphertext using password
            function TEAdecrypt(ciphertext, password) {
                if (ciphertext.length === 0) return '';

                // Note: The original TiddlyWiki plugin would first call CheckTiddlerForDecryption_TiddlerEncryptionPlugin,
                // which extracts the encrypted content after "Encrypted(SHA1_HASH)\n" and then calls HexToString_TiddlerEncryptionPlugin.
                // We assume the input `ciphertext` for this function is already in the 'raw' hex-string format.
                
                let v = strToLongs(unescCtrlCh(ciphertext));
                let k = strToLongs(password.slice(0, 16)); // Key derived from first 16 chars of password
                let n = v.length;

                let z = v[n - 1],
                    y = v[0],
                    delta = 0x9E3779B9;
                let mx, e, q = Math.floor(6 + 52 / n),
                    sum = q * delta;

                while (sum !== 0) {
                    e = sum >>> 2 & 3;
                    for (let p = n - 1; p >= 0; p--) {
                        z = v[p > 0 ? p - 1 : n - 1];
                        mx = (z >>> 5 ^ y << 2) + (y >>> 3 ^ z << 4) ^ (sum ^ y) + (k[p & 3 ^ e] ^ z);
                        y = v[p] -= mx;
                    }
                    sum -= delta;
                }

                let plaintext = longsToStr(v);

                // strip trailing null chars resulting from filling 4-char blocks:
                plaintext = plaintext.replace(/\0+$/, '');

                return unescape(plaintext); // Reverses the `escape` function used during encryption
            }

            // Helper: Converts string to array of 32-bit integers (longs)
            function strToLongs(s) {
                let l = new Array(Math.ceil(s.length / 4));
                for (let i = 0; i < l.length; i++) {
                    l[i] = s.charCodeAt(i * 4) +
                           (s.charCodeAt(i * 4 + 1) << 8) +
                           (s.charCodeAt(i * 4 + 2) << 16) +
                           (s.charCodeAt(i * 4 + 3) << 24);
                }
                return l;
            }

            // Helper: Converts array of 32-bit integers (longs) back to string
            function longsToStr(l) {
                let a = new Array(l.length);
                for (let i = 0; i < l.length; i++) {
                    a[i] = String.fromCharCode(l[i] & 0xFF,
                                               l[i] >>> 8 & 0xFF,
                                               l[i] >>> 16 & 0xFF,
                                               l[i] >>> 24 & 0xFF);
                }
                return a.join('');
            }

            // Helper: Unescape potentially problematic nulls and control characters
            function unescCtrlCh(str) {
                return str.replace(/!\d\d?\d?!/g, function(c) { return String.fromCharCode(parseInt(c.slice(1, -1))); });
            }

            // Helper: Converts hexadecimal string to original string (used for the raw encrypted content)
            function HexToString_TiddlerEncryptionPlugin(theString) {
                let theResult = "";
                for (let i = 0; i < theString.length; i += 2) {
                    if (theString.charAt(i) === "\n") {
                        i--; // Skip over the newline and resume
                        continue;
                    }
                    theResult += String.fromCharCode(parseInt(theString.substr(i, 2), 16));
                }
                return theResult;
            }

            // --- Event Listener for Decryption Button ---

            decryptButton.addEventListener('click', () => {
                statusMessage.textContent = ''; // Clear previous messages
                decryptedOutput.textContent = ''; // Clear previous output

                const rawEncryptedText = encryptedTextInput.value.trim();
                const password = passwordInput.value;

                if (!rawEncryptedText) {
                    statusMessage.textContent = 'Please paste the encrypted text.';
                    return;
                }
                if (!password) {
                    statusMessage.textContent = 'Please enter the password.';
                    return;
                }

                try {
                    // Step 1: Convert the input (which is in a hex-like format) back to the internal string format
                    const preProcessedCiphertext = HexToString_TiddlerEncryptionPlugin(rawEncryptedText);

                    // Step 2: Perform TEA decryption
                    const decryptedContent = TEAdecrypt(preProcessedCiphertext, password);
                    decryptedOutput.textContent = decryptedContent;
                    statusMessage.textContent = 'Decryption successful!';
                    statusMessage.style.color = 'green';
                } catch (error) {
                    console.error('Decryption error:', error);
                    statusMessage.textContent = `Decryption failed: ${error.message || 'An unknown error occurred.'}`;
                    statusMessage.style.color = 'red';
                }
            });
        });
    </script>
</body>
</html>